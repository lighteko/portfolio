name: Deploy Next.js App to OCI (via GHCR)

on:
  workflow_dispatch:
    inputs:
      ref:
        description: "deploy할 git ref (branch/tag/sha). 비우면 default"
        required: false
        default: ""

jobs:
  deploy:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write # GHCR push에 필요

    env:
      # 기본: ghcr.io/<owner>/<repo>:latest
      GHCR_IMAGE: ghcr.io/${{ github.repository }}:latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.ref != '' && github.event.inputs.ref || github.sha }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }} # GitHub Actions 기본 토큰으로 push 가능

      - name: Build and push Docker image to GHCR
        run: |
          echo "Building: $GHCR_IMAGE"
          docker build -t "$GHCR_IMAGE" .
          docker push "$GHCR_IMAGE"

      - name: Deploy to OCI (SSH + docker compose)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.OCI_HOST }}
          username: ${{ secrets.OCI_SSH_USER }}
          key: ${{ secrets.OCI_SSH_KEY }}
          script: |
            set -e
            cd /opt/portfolio

            # ⚠️ 원격 서버에서 GHCR pull 하려면 PAT 필요함 (read:packages)
            echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io \
              -u "${{ secrets.GHCR_USERNAME }}" --password-stdin

            docker compose pull
            docker compose up -d
            docker image prune -f
